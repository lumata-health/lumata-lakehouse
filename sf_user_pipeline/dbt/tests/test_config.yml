# Test configuration for sf_user SCD pipeline
# This file defines test execution order, severity levels, and dependencies
# Requirements: 4.1, 4.2, 5.1, 7.1 - Comprehensive testing configuration

version: 2

# Test execution groups - tests within a group can run in parallel
test_groups:
  
  # Group 1: Basic data quality tests (run first)
  data_quality:
    description: "Basic data quality validation tests"
    severity: error
    tests:
      - test_sf_user_data_quality_comprehensive
      - source_freshness:sf_raw.sf_user
    dependencies: []
    
  # Group 2: SCD integrity tests (run after data quality)
  scd_integrity:
    description: "SCD Type 2 integrity validation tests"
    severity: error
    tests:
      - test_scd_integrity_sf_user
      - test_scd_integrity_comprehensive
      - test_scd_is_current_flag_logic
    dependencies: [data_quality]
    
  # Group 3: SCD logic tests (run after integrity tests)
  scd_logic:
    description: "SCD Type 2 logic correctness tests"
    severity: error
    tests:
      - test_scd_type2_logic_correctness
      - test_scd_currency_management_sf_user
      - test_scd_tracked_fields_sf_user
    dependencies: [scd_integrity]
    
  # Group 4: SCD continuity tests (run after logic tests)
  scd_continuity:
    description: "SCD Type 2 temporal continuity tests"
    severity: error
    tests:
      - test_scd_no_gaps_overlaps
    dependencies: [scd_logic]
    
  # Group 5: Performance and monitoring tests (run last)
  performance:
    description: "Performance and monitoring validation tests"
    severity: warn
    tests:
      - dbt_utils.expression_is_true:
          expression: "count(*) < {{ var('max_records_per_batch') }}"
          model: ref('dim_sf_user_scd')
      - dbt_utils.expression_is_true:
          expression: "count(distinct user_id) > 0"
          model: ref('dim_sf_user_scd')
    dependencies: [scd_continuity]

# Test thresholds and configurations
test_thresholds:
  max_violation_percentage: 1.0  # Maximum 1% violations allowed
  max_execution_time_minutes: 30  # Maximum test execution time
  data_quality_threshold: 95.0   # Minimum 95% data quality score
  
# Test reporting configuration
reporting:
  generate_html_report: true
  include_test_details: true
  alert_on_failure: true
  alert_channels: ["email", "slack"]
  
# Test data configuration for development/testing
test_data:
  use_sample_data: false
  sample_size: 1000
  date_range_days: 30
  
# Custom test variables
custom_variables:
  scd_test_user_sample: ['005000000000001', '005000000000002', '005000000000003']
  test_division_changes: ['North', 'South', 'East']
  test_audit_phases: ['Phase1', 'Phase2', 'Phase3']