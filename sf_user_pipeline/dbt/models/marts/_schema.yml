version: 2

models:
  - name: dim_sf_user_scd
    description: "SCD Type 2 dimension for sf_user with historical tracking of Division and Audit_Phase__c changes"
    
    tests:
      # Custom SCD integrity tests using our macros
      - dbt_utils.expression_is_true:
          expression: "user_key is not null"
          config:
            severity: error
            
      # SCD Type 2 integrity tests
      - dbt_utils.expression_is_true:
          expression: "not (is_deleted = true and is_current = true)"
          config:
            severity: error
            error_if: ">0"
            warn_if: ">0"
          name: "deleted_records_not_current"
          
      # Ensure unique current records per user
      - dbt_utils.unique_combination_of_columns:
          combination_of_columns:
            - user_id
            - is_current
          where: "is_current = true and is_deleted = false"
          config:
            severity: error
            
      # Validate SCD identifier uniqueness
      - unique:
          column_name: _scd_id
          config:
            severity: error
            
      # New comprehensive data quality tests
      - scd_current_record_uniqueness:
          user_id_column: user_id
          config:
            severity: error
            
      - scd_proper_dating:
          user_id_column: user_id
          date_column: update_date
          config:
            severity: error
            
    columns:
      - name: user_key
        description: "Surrogate key for SCD record (generated from user_id + update_date)"
        tests:
          - not_null
          - unique
          
      - name: user_id
        description: "Salesforce User ID (Natural Key)"
        tests:
          - not_null
          - sf_user_data_types:
              column_name: user_id
          
      - name: name
        description: "User full name"
        tests:
          - not_null
          - sf_user_data_types:
              column_name: name
          
      - name: division
        description: "User division (SCD tracked field)"
        tests:
          - not_null
          - accepted_values:
              values: ['North', 'South', 'East', 'West', 'Central']
          - sf_user_data_types:
              column_name: division
              
      - name: audit_phase__c
        description: "Custom audit phase field (SCD tracked field)"
        tests:
          - not_null
          - accepted_values:
              values: ['Phase1', 'Phase2', 'Phase3', 'Complete']
          - sf_user_data_types:
              column_name: audit_phase__c
              
      - name: is_active
        description: "User active status at the time of this record version"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: update_date
        description: "Effective date when this record version became active"
        tests:
          - not_null
          
      - name: is_current
        description: "Flag indicating if this is the current version of the record"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: is_deleted
        description: "Flag indicating if the user record was deleted"
        tests:
          - not_null
          - accepted_values:
              values: [true, false]
              
      - name: _dbt_updated_at
        description: "Timestamp when this record was last updated by dbt"
        tests:
          - not_null
          
      - name: _extracted_at
        description: "Timestamp when the source data was extracted"
        tests:
          - not_null
          
      - name: _extraction_run_id
        description: "Extraction run identifier from source system"
        tests:
          - not_null
          
      - name: _scd_id
        description: "Unique identifier for SCD merge operations"
        tests:
          - not_null
          - unique
          
      - name: version_sequence
        description: "Sequential version number for each user's SCD records"
        tests:
          - not_null
          - dbt_utils.expression_is_true:
              expression: "version_sequence >= 1"